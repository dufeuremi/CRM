<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Call manager - Taskalys</title>
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@100;200;300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css?v=20251116-10">
    <link rel="stylesheet" href="mails_styles.css?v=20251116-10">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2 class="sidebar-logo">
                    <img src="assets/logo.svg" alt="Taskalys" class="logo-img">
                </h2>
                <button class="toggle-btn" id="toggleBtn">
                    <i data-lucide="chevron-left"></i>
                </button>
            </div>
            
            <nav class="sidebar-nav">
                <ul class="nav-list">
                    <li class="nav-item">
                        <a href="#" class="nav-link active" data-section="dashboard">
                            <i data-lucide="activity"></i>
                            <span class="nav-text">Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item admin-only" id="analyticsNavItem" style="display: none;">
                        <a href="#" class="nav-link" data-section="analytics">
                            <i data-lucide="bar-chart-3"></i>
                            <span class="nav-text">Analytics</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-section="script">
                            <i data-lucide="file-text"></i>
                            <span class="nav-text">Script</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-section="presentation">
                            <i data-lucide="presentation"></i>
                            <span class="nav-text">Présentation</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-section="prospects">
                            <i data-lucide="users"></i>
                            <span class="nav-text">Prospection</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-section="rappels">
                            <i data-lucide="bell"></i>
                            <span class="nav-text">Relances</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-section="disponibilites">
                            <i data-lucide="calendar"></i>
                            <span class="nav-text">Disponibilités</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-section="mails">
                            <i data-lucide="mail"></i>
                            <span class="nav-text">Mails</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-section="historique">
                            <i data-lucide="phone"></i>
                            <span class="nav-text">Appels</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-section="infos">
                            <i data-lucide="calculator"></i>
                            <span class="nav-text">Comptabilité</span>
                        </a>
                    </li>
                </ul>
            </nav>
            
            <!-- User Section -->
            <div class="sidebar-footer">
                <div class="user-info">
                    <img src="assets/default.webp" alt="Utilisateur" class="user-avatar">
                    <div class="user-details">
                        <span class="user-first-name">Prénom</span>
                        <span class="user-last-name">Nom</span>
                    </div>
                </div>
                <button class="logout-btn" id="logoutBtn">
                    <i data-lucide="log-out"></i>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="top-header">
                <button class="menu-toggle" id="menuToggle">
                    <i data-lucide="menu"></i>
                </button>
                <h1 class="page-title" id="pageTitle">Dashboard</h1>
                <div class="support-actions" style="margin-left:auto; display:flex; gap:0.5rem; align-items:center;">
                    <button class="btn btn-secondary" id="supportBtn" style="display:flex; align-items:center; gap:0.5rem; font-size:0.875rem; padding:0.5rem 1rem;">
                        <i data-lucide="alert-circle" style="width:18px; height:18px;"></i>
                        <span>Signaler un problème</span>
                    </button>
                    <button class="btn btn-outline" id="customActionBtn" style="display:flex; align-items:center; gap:0.5rem; font-size:0.875rem; padding:0.5rem 1rem;">
                        <i data-lucide="plus-circle" style="width:18px; height:18px;"></i>
                        <span>Créer une action</span>
                    </button>
                    <button class="btn btn-primary" id="suggestsBtn" style="display:flex; align-items:center; gap:0.5rem; font-size:0.875rem; padding:0.5rem 1rem; position:relative;">
                        <i data-lucide="brain" style="width:18px; height:18px;"></i>
                        <span>Agent</span>
                        <span class="agent-notification-badge" id="agentNotificationBadge" style="display:none;">0</span>
                    </button>
                </div>
            </header>

            <div class="content-wrapper">
                <!-- Dashboard Section -->
                <section class="content-section active" id="dashboard">
                    <div class="dashboard-loading" id="dashboardLoading" style="display: flex;">
                        <div class="loading-spinner"></div>
                    </div>
                    
                    <div class="dashboard-content" id="dashboardContent" style="display: none;">
                        <!-- Mission reminder -->
                        <div class="mission-reminder" id="missionReminder" style="display: none;">
                            <div class="mission-icon">
                                <i data-lucide="target"></i>
                            </div>
                            <div class="mission-content">
                                <p class="mission-greeting" id="missionGreeting"></p>
                                <p class="mission-text" id="missionText"></p>
                            </div>
                        </div>
                        
                        <div class="dashboard-grid">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i data-lucide="phone"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="callsThisWeek">0</h3>
                                <p>Appels cette semaine</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i data-lucide="user-check"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="totalContacts">0</h3>
                                <p>Prospects contactés au total</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i data-lucide="calendar-check"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="bookedAppointments">0</h3>
                                <p>RDV planifiés</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i data-lucide="trophy"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="conversionRate">0%</h3>
                                <p>Taux de RDV</p>
                            </div>
                        </div>
                        </div>
                        
                        <!-- Graphique Statistiques d'appels -->
                        <div class="chart-container">
                            <div class="chart-header">
                                <h3>Statistiques d'appels</h3>
                                <div class="stats-controls">
                                    <div class="stats-period-selector">
                                        <label for="statsPeriod">Période:</label>
                                        <select id="statsPeriod" class="stats-period-select">
                                            <option value="all">Depuis le début</option>
                                            <option value="7">7 derniers jours</option>
                                            <option value="30">30 derniers jours</option>
                                            <option value="90">90 derniers jours</option>
                                        </select>
                                    </div>
                                    <div class="stats-toggles">
                                        <label class="stats-toggle-item">
                                            <input type="checkbox" id="toggleCalls" checked>
                                            <span class="toggle-label">Nombre d'appels</span>
                                        </label>
                                        <label class="stats-toggle-item">
                                            <input type="checkbox" id="togglePickupRate" checked>
                                            <span class="toggle-label">Effectif qui a décroché</span>
                                        </label>
                                        <label class="stats-toggle-item">
                                            <input type="checkbox" id="toggleMeetingRate" checked>
                                            <span class="toggle-label">Effectif RDV</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div id="callStatsEmpty" class="chart-empty-state" style="display: none;">
                                <div class="chart-empty-icon">
                                    <i data-lucide="phone"></i>
                                </div>
                                <h4>Commencez à passer des appels !</h4>
                                <p>Vos statistiques d'appels apparaîtront ici une fois que vous aurez commencé.</p>
                            </div>
                            <canvas id="callStatsChart"></canvas>
                        </div>
                        
                        <!-- Graphique Chiffre d'affaires -->
                        <div class="chart-container">
                            <div class="chart-header">
                                <h3>Chiffre d'affaires</h3>
                            </div>
                            <div id="revenueChartEmpty" class="chart-empty-state" style="display: none;">
                                <div class="chart-empty-icon">
                                    <i data-lucide="trending-up"></i>
                                </div>
                                <h4>Commencez à générer du chiffre d'affaires !</h4>
                                <p>Convertissez vos prospects en clients pour voir votre progression ici. Chaque conversion vous rapporte 250€.</p>
                            </div>
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                </section>

                <!-- Analytics Section -->
                <section class="content-section" id="analytics">
                    <div class="analytics-loading" id="analyticsLoading" style="display: flex;">
                        <div class="loading-spinner"></div>
                    </div>
                    
                    <div class="analytics-content" id="analyticsContent" style="display: none;">
                        <!-- Sélecteur d'utilisateur -->
                        <!-- Tableau comparatif des utilisateurs -->
                        <div class="analytics-comparison-section">
                            <div class="analytics-section-header">
                                <div>
                                    <h3><i data-lucide="users"></i> Comparaison des performances</h3>
                                    <p>Comparez les performances de tous les commerciaux sur la période sélectionnée</p>
                                </div>
                                <div class="comparison-controls">
                                    <button class="btn btn-secondary" id="selectAllUsers">Tout sélectionner</button>
                                    <button class="btn btn-secondary" id="unselectAllUsers">Tout désélectionner</button>
                                </div>
                            </div>

                            <!-- Filtres de période et utilisateurs -->
                            <div class="analytics-filters">
                                <div class="analytics-filters-row">
                                    <div class="user-filter-container">
                                        <label for="userFilter" class="form-label">Analyser l'utilisateur :</label>
                                        <select id="userFilter" class="form-select">
                                            <option value="">Choisir un utilisateur...</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="analytics-filters-row">
                                    <div class="date-filter-shortcuts">
                                        <button class="date-shortcut-btn" data-days="1">24h</button>
                                        <button class="date-shortcut-btn" data-days="7">7 jours</button>
                                        <button class="date-shortcut-btn" data-days="30">30 jours</button>
                                        <button class="date-shortcut-btn" data-days="60">60 jours</button>
                                        <button class="date-shortcut-btn" data-days="90">90 jours</button>
                                    </div>
                                    
                                    <div class="date-range-container">
                                        <div class="date-filter-container">
                                            <label for="startDateFilter" class="form-label"></label>
                                            <input type="date" id="startDateFilter" class="form-input">
                                        </div>
                                        <div class="date-filter-container">
                                            <label for="endDateFilter" class="form-label"></label>
                                            <input type="date" id="endDateFilter" class="form-input">
                                        </div>
                                    </div>
                                    
                                    <div class="filter-actions">
                                        <button class="btn btn-primary" id="applyFilters">Appliquer</button>
                                        <button class="btn btn-secondary" id="resetFilters">Réinitialiser</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Graphique de comparaison -->
                            <div class="chart-container">
                                <div class="chart-header">
                                    <h3>Évolution comparative des performances</h3>
                                    <div class="stats-controls">
                                        <div class="stats-period-selector">
                                            <label for="comparisonPeriod">Période:</label>
                                            <select id="comparisonPeriod" class="stats-period-select">
                                                <option value="all">Depuis le début</option>
                                                <option value="7">7 derniers jours</option>
                                                <option value="30" selected>30 derniers jours</option>
                                                <option value="90">90 derniers jours</option>
                                            </select>
                                        </div>
                                        <div class="stats-toggles">
                                            <label class="stats-toggle-item">
                                                <input type="checkbox" id="toggleComparisonCalls" checked>
                                                <span class="toggle-label">Nombre d'appels</span>
                                            </label>
                                            <label class="stats-toggle-item">
                                                <input type="checkbox" id="toggleComparisonAnswered" checked>
                                                <span class="toggle-label">Appels décrochés</span>
                                            </label>
                                            <label class="stats-toggle-item">
                                                <input type="checkbox" id="toggleComparisonMeetings" checked>
                                                <span class="toggle-label">RDV obtenus</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div id="comparisonChartEmpty" class="chart-empty-state" style="display: none;">
                                    <div class="chart-empty-icon">
                                        <i data-lucide="users"></i>
                                    </div>
                                    <h4>Sélectionnez des utilisateurs à comparer</h4>
                                    <p>Cochez les commerciaux dans le tableau ci-dessous pour voir leurs performances comparées.</p>
                                </div>
                                <canvas id="comparisonChart"></canvas>
                            </div>
                            
                            <div class="comparison-table-container">
                                <div class="comparison-loading" id="comparisonLoading" style="display: none;">
                                    <div class="loading-spinner"></div>
                                </div>
                                
                                <table class="comparison-table" id="comparisonTable">
                                    <thead>
                                        <tr>
                                            <th class="comparison-checkbox-col">
                                                <input type="checkbox" id="selectAllCheckbox" title="Sélectionner tout">
                                            </th>
                                            <th>Commercial</th>
                                            <th>Appels</th>
                                            <th>Chaleur moyenne</th>
                                            <th>Taux de réponse</th>
                                            <th>Taux de RDV</th>
                                            <th>Prospects</th>
                                            <th>Performance</th>
                                        </tr>
                                    </thead>
                                    <tbody id="comparisonTableBody">
                                        <tr>
                                            <td colspan="8" class="comparison-empty">
                                                <i data-lucide="users"></i>
                                                <p>Aucune donnée disponible pour cette période</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Section 1: Pipeline & Conversions -->
                        <div class="analytics-section">
                            <div class="analytics-section-header">
                                <div>
                                    <h3><i data-lucide="target"></i> Pipeline & Conversions</h3>
                                    <p>Suivre l'efficacité du BDR à transformer ses leads</p>
                                </div>
                            </div>
                            <div class="analytics-grid">
                                <div class="kpi-card">
                                    <div class="kpi-icon"><i data-lucide="user-plus"></i></div>
                                    <div class="kpi-content">
                                        <h4 id="newProspectsCount">0</h4>
                                        <p>Nouveaux prospects créés</p>
                                    </div>
                                </div>
                                <div class="kpi-card">
                                    <div class="kpi-icon"><i data-lucide="check-circle"></i></div>
                                    <div class="kpi-content">
                                        <h4 id="qualificationRate">0%</h4>
                                        <p>Taux de qualification</p>
                                    </div>
                                </div>
                                <div class="kpi-card">
                                    <div class="kpi-icon"><i data-lucide="calendar"></i></div>
                                    <div class="kpi-content">
                                        <h4 id="rdvConversionRate">0%</h4>
                                        <p>Taux de conversion en RDV</p>
                                    </div>
                                </div>
                                <div class="kpi-card">
                                    <div class="kpi-icon"><i data-lucide="dollar-sign"></i></div>
                                    <div class="kpi-content">
                                        <h4 id="clientConversionRate">0%</h4>
                                        <p>Taux de conversion en client</p>
                                    </div>
                                </div>
                                <div class="kpi-card">
                                    <div class="kpi-icon"><i data-lucide="clock"></i></div>
                                    <div class="kpi-content">
                                        <h4 id="avgConversionTime">0j</h4>
                                        <p>Temps moyen de conversion</p>
                                    </div>
                                </div>
                            </div>
                            <div class="analytics-chart-container">
                                <div class="chart-header">
                                    <h3>Funnel de conversion</h3>
                                </div>
                                <canvas id="conversionFunnelChart"></canvas>
                            </div>
                            <div class="analytics-chart-container">
                                <div class="chart-header">
                                    <h3>Nouveaux prospects par jour</h3>
                                </div>
                                <canvas id="newProspectsChart"></canvas>
                            </div>
                        </div>

                        <!-- Section 2: Activité d'appels (supprimé Répartition par température) -->
                        <div class="analytics-section">
                            <div class="analytics-section-header">
                                <div>
                                    <h3><i data-lucide="phone"></i> Activité d'appels</h3>
                                    <p>Mesurer l'intensité et la qualité de la prospection</p>
                                </div>
                            </div>
                            <div class="analytics-grid">
                                <div class="kpi-card">
                                    <div class="kpi-icon"><i data-lucide="phone-call"></i></div>
                                    <div class="kpi-content">
                                        <h4 id="callsCount">0</h4>
                                        <p>Nombre d'appels passés</p>
                                    </div>
                                </div>
                                <div class="kpi-card">
                                    <div class="kpi-icon"><i data-lucide="thumbs-up"></i></div>
                                    <div class="kpi-content">
                                        <h4 id="positiveCallsRate">0%</h4>
                                        <p>% d'appels avec statut positif</p>
                                    </div>
                                </div>
                            </div>
                            <div class="analytics-chart-container">
                                <div class="chart-header">
                                    <h3>Appels par jour</h3>
                                </div>
                                <canvas id="callsPerDayChart"></canvas>
                            </div>
                        </div>

                        <!-- Section 3: Performance individuelle -->
                        <div class="analytics-section">
                            <div class="analytics-section-header">
                                <div>
                                    <h3><i data-lucide="user"></i> Performance individuelle</h3>
                                    <p>Évaluer l'efficacité de chaque commercial</p>
                                </div>
                            </div>
                            <div class="analytics-grid">
                                <div class="kpi-card">
                                    <div class="kpi-icon"><i data-lucide="users"></i></div>
                                    <div class="kpi-content">
                                        <h4 id="assignedProspects">0</h4>
                                        <p>Prospects assignés</p>
                                    </div>
                                </div>
                                <div class="kpi-card">
                                    <div class="kpi-icon"><i data-lucide="calendar-check"></i></div>
                                    <div class="kpi-content">
                                        <h4 id="bookedRdv">0</h4>
                                        <p>RDV bookés</p>
                                    </div>
                                </div>
                                <div class="kpi-card">
                                    <div class="kpi-icon"><i data-lucide="phone"></i></div>
                                    <div class="kpi-content">
                                        <h4 id="totalCallsMade">0</h4>
                                        <p>Appels effectués</p>
                                    </div>
                                </div>
                                <div class="kpi-card">
                                    <div class="kpi-icon"><i data-lucide="trending-up"></i></div>
                                    <div class="kpi-content">
                                        <h4 id="globalConversionRate">0%</h4>
                                        <p>Taux de conversion global</p>
                                    </div>
                                </div>
                                <div class="kpi-card">
                                    <div class="kpi-icon"><i data-lucide="activity"></i></div>
                                    <div class="kpi-content">
                                        <h4 id="followUpRate">0%</h4>
                                        <p>Taux de suivi</p>
                                    </div>
                                </div>
                            </div>
                        </div>



                    </div>
                </section>

                <!-- Disponibilités Section -->
                <section class="content-section" id="disponibilites">
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <div class="calendar-nav-left">
                                <button class="btn-nav" id="prevBtn">
                                    <i data-lucide="chevron-left"></i>
                                </button>
                                <button class="btn-nav" id="nextBtn">
                                    <i data-lucide="chevron-right"></i>
                                </button>
                                <h3 class="calendar-title" id="calendarTitle">Semaine du ...</h3>
                            </div>
                            <div class="calendar-nav-right">
                                <div class="view-selector">
                                    <button class="view-btn" data-view="jour">Jour</button>
                                    <button class="view-btn active" data-view="semaine">Semaine</button>
                                    <button class="view-btn" data-view="mois">Mois</button>
                                </div>
                                <button class="btn btn-secondary" id="todayBtn">Aujourd'hui</button>
                            </div>
                        </div>
                        <div class="calendar-view" id="calendarView">
                            <!-- Le contenu sera généré dynamiquement selon la vue -->
                        </div>
                        <div class="calendar-loading" id="calendarLoading" style="display: none;">
                            <div class="loading-spinner"></div>
                        </div>
                    </div>
                </section>

                <!-- Rappels Section -->
                <section class="content-section" id="rappels">
                    <!-- Section Rappels Téléphoniques -->
                    <div class="section-header" style="margin-bottom: 1rem;">
                        <h2 style="font-size: 1.5rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                            <i data-lucide="phone" style="width: 24px; height: 24px;"></i>
                            Rappels 
                        </h2>
                    </div>
                    <div class="calendar-container" style="margin-bottom: 2rem;">
                        <div class="calendar-header">
                            <div class="calendar-nav-left">
                                <button class="btn-nav" id="rappelsPrevBtn">
                                    <i data-lucide="chevron-left"></i>
                                </button>
                                <button class="btn-nav" id="rappelsNextBtn">
                                    <i data-lucide="chevron-right"></i>
                                </button>
                                <h3 class="calendar-title" id="rappelsCalendarTitle">Semaine du ...</h3>
                            </div>
                            <div class="calendar-nav-right">
                                <button class="btn btn-secondary" id="rappelsTodayBtn">Aujourd'hui</button>
                            </div>
                        </div>
                        <div class="calendar-view" id="rappelsCalendarView">
                            <!-- Le contenu sera généré dynamiquement selon la vue -->
                        </div>
                        <div class="calendar-loading" id="rappelsCalendarLoading" style="display: none;">
                            <div class="loading-spinner"></div>
                        </div>
                    </div>

                    <!-- Section Emails Programmés -->
                    <div class="section-header" style="margin-bottom: 1rem;">
                        <h2 style="font-size: 1.5rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                            <i data-lucide="calendar-clock" style="width: 24px; height: 24px;"></i>
                            Emails programmés
                        </h2>
                    </div>
                    <div class="section-content">
                        <div class="mails-container" id="scheduledEmailsContainer">
                            <!-- Les emails programmés seront générés dynamiquement -->
                        </div>
                    </div>
                </section>

                <!-- Historique des appels Section -->
                <section class="content-section" id="historique">
                    <div class="section-header">
                        <div class="prospects-search-container">
                            <div class="search-wrapper">
                                <i data-lucide="search" class="search-icon"></i>
                                <input type="text" id="historiqueSearch" class="search-input" placeholder="Rechercher dans l'historique...">
                            </div>
                            <div class="prospects-filter-container">
                                <button class="prospect-filter-tag active" data-filter="all" id="historiqueFilterAll">Tous</button>
                                <button class="prospect-filter-tag" data-filter="answered" id="historiqueFilterAnswered">Décroché</button>
                                <button class="prospect-filter-tag" data-filter="no_answer" id="historiqueFilterNoAnswer">Pas décroché</button>
                                <button class="prospect-filter-tag" data-filter="converted" id="historiqueFilterConverted">Converti (RDV)</button>
                            </div>
                        </div>
                    </div>
                    <div class="section-content">
                        <div class="historique-loading" id="historiqueLoading" style="display: none;">
                            <div class="loading-spinner"></div>
                        </div>
                        <div class="historique-container" id="historiqueContainer">
                            <!-- L'historique sera généré dynamiquement -->
                        </div>
                    </div>
                </section>

                <!-- Mails Section -->
                <section class="content-section" id="mails">
                    <div class="section-header">
                        <div class="prospects-search-container">
                            <div class="search-wrapper">
                                <i data-lucide="search" class="search-icon"></i>
                                <input type="text" id="mailsSearch" class="search-input" placeholder="Rechercher dans les emails...">
                            </div>
                            <div class="prospects-filter-container">
                                <button class="prospect-filter-tag active" data-filter="all" id="mailsFilterAll">Tous</button>
                                <button class="prospect-filter-tag" data-filter="sent" id="mailsFilterSent">Envoyés</button>
                                <button class="prospect-filter-tag" data-filter="received" id="mailsFilterReceived">Reçus</button>
                            </div>
                        </div>
                    </div>
                    <div class="section-content">
                        <div class="mails-loading" id="mailsLoading" style="display: none;">
                            <div class="loading-spinner"></div>
                        </div>
                        <div class="mails-container" id="mailsContainer">
                            <!-- Les emails seront générés dynamiquement -->
                        </div>
                    </div>
                </section>

                <!-- Prospects Section -->
                <section class="content-section" id="prospects">
                    <div class="section-header">
                        <div class="prospects-search-container">
                            <div class="search-wrapper">
                                <i data-lucide="search" class="search-icon"></i>
                                <input type="text" id="prospectsSearch" class="search-input" placeholder="Rechercher un prospect...">
                            </div>
                            <div class="prospects-filter-container">
                                <button class="prospect-filter-tag" data-filter="called" id="filterCalled">Déjà contactés</button>
                                <button class="prospect-filter-tag" data-filter="not_called" id="filterNotCalled">Non contactés</button>
                                <button class="prospect-filter-tag" data-filter="booked" id="filterBooked">Réservé</button>
                            </div>
                        </div>
                        <button class="btn btn-primary" id="addProspectBtn">
                            <i data-lucide="plus"></i> Ajouter un prospect
                        </button>
                    </div>
                    <div class="section-content">
                        <div class="prospects-loading" id="prospectsLoading" style="display: none;">
                            <div class="loading-spinner"></div>
                        </div>
                        <div class="table-container" id="prospectsTableContainer">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Nom</th>
                                        <th>Entreprise</th>
                                        <th>Téléphone</th>
                                        <th>Email</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="5" class="empty-table">
                                            <i data-lucide="inbox"></i>
                                            <p>Aucun prospect pour le moment</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Script Section -->
                <section class="content-section" id="script">
                    <div class="presentation-container">
                        <iframe src="assets/script.pdf#toolbar=1&navpanes=0" class="presentation-iframe" frameborder="0"></iframe>
                    </div>
                </section>

                <!-- Présentation Section -->
                <section id="presentation" class="content-section">
                    <div class="presentation-container">
                        <iframe src="assets/presentation.pdf#toolbar=1&navpanes=0" class="presentation-iframe" frameborder="0"></iframe>
                    </div>
                </section>

                <!-- Comptabilité Section -->
                <section id="infos" class="content-section">
                    <div class="infos-container">
                        <div class="infos-card">
                            <div class="infos-card-header">
                                <i data-lucide="landmark"></i>
                                <h3>URSSAF</h3>
                            </div>
                            <div class="infos-card-body">
                                <p>Gérez vos déclarations et créez votre compte auto-entrepreneur.</p>
                                <div class="infos-links">
                                    <a href="https://www.autoentrepreneur.urssaf.fr/portail/accueil.html" target="_blank" class="btn btn-secondary">
                                        <i data-lucide="settings"></i>
                                        <span>Gestion de ma micro-entreprise</span>
                                    </a>
                                    <a href="https://www.autoentrepreneur.urssaf.fr/portail/accueil/une-question/declarer-et-payer.html" target="_blank" class="btn btn-primary">
                                        <i data-lucide="file-text"></i>
                                        <span>Déclarer mon chiffre d'affaires</span>
                                    </a>
                                </div>
                            </div>
                        </div>

                        <div class="infos-card">
                            <div class="infos-card-header">
                                <i data-lucide="receipt"></i>
                                <h3>Génération de facture</h3>
                            </div>
                            <div class="infos-card-body">
                                <p>Générez votre facture à destination de Taskalys (250€ HT).</p>
                                
                                <div class="invoice-form">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>SIRET *</label>
                                            <input type="text" id="invoiceSiret" placeholder="12345678901234" class="form-input">
                                        </div>
                                        <div class="form-group">
                                            <label>Code APE *</label>
                                            <input type="text" id="invoiceApe" placeholder="6201Z" class="form-input">
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>TVA Intracommunautaire</label>
                                            <input type="text" id="invoiceTva" placeholder="FR12345678901" class="form-input">
                                        </div>
                                        <div class="form-group">
                                            <label>Baseline/Activité</label>
                                            <input type="text" id="invoiceBaseline" placeholder="Business developper" class="form-input">
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Adresse complète *</label>
                                        <textarea id="invoiceAddress" placeholder="123 Rue Example&#10;75001 Paris" class="form-textarea"></textarea>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>IBAN *</label>
                                            <input type="text" id="invoiceIban" placeholder="FR76 1234 1234 1234 1234 1234 123" class="form-input">
                                        </div>
                                        <div class="form-group">
                                            <label>BIC</label>
                                            <input type="text" id="invoiceBic" placeholder="ABCDFRPP" class="form-input">
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Téléphone</label>
                                            <input type="text" id="invoicePhone" placeholder="06 12 34 56 78" class="form-input">
                                        </div>
                                        <div class="form-group">
                                            <label>Site web/Linkedin</label>
                                            <input type="text" id="invoiceWebsite" placeholder="https://monsite.fr" class="form-input">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="infos-links">
                                    <button id="generateInvoiceBtn" class="btn btn-primary">
                                        <i data-lucide="download"></i>
                                        <span>Générer la facture PDF</span>
                                    </button>
                                </div>
                                
                                <div class="infos-note">
                                    <i data-lucide="info"></i>
                                    <span>Vous facturez 250€ HT à Taskalys en tant que prestataire</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>

        <!-- Agent Right Sidebar -->
        <aside class="agent-sidebar" id="agentSidebar">
            <div class="agent-sidebar-header">
                <h3 class="agent-sidebar-title">
                    <i data-lucide="brain"></i>
                    CRM Agent
                </h3>
                <button class="agent-sidebar-close" id="closeAgentSidebar">
                    <i data-lucide="x"></i>
                </button>
            </div>
            
            <div class="agent-sidebar-content">
                <div class="agent-loading" id="agentLoading" style="display: flex;">
                    <div class="loading-spinner"></div>
                </div>
                
                <div class="agent-events-list" id="agentEventsList" style="display: none;">
                    <!-- Events will be populated dynamically -->
                </div>

                <div class="agent-empty" id="agentEmpty" style="display: none;">
                    <div class="empty-state">
                        <i data-lucide="inbox"></i>
                        <h4>Aucun événement</h4>
                        <p>Les suggestions apparaîtront ici</p>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <!-- Custom Alert Modal -->
    <div id="customAlertModal" class="modal-overlay">
        <div class="modal-content modal-content-small">
            <div class="modal-header">
                <h3 class="modal-title" id="customAlertTitle">Information</h3>
                <button class="modal-close" id="closeCustomAlert">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <p id="customAlertMessage"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="customAlertOk">OK</button>
            </div>
        </div>
    </div>

    <!-- Custom Action Dropdown -->
    <div id="customActionDropdown" class="custom-action-dropdown" style="display:none;">
        <button class="custom-action-item" data-action="email">
            <i data-lucide="mail"></i>
            <span>Envoyer un email</span>
        </button>
        <button class="custom-action-item" data-action="rappel">
            <i data-lucide="bell"></i>
            <span>Planifier un rappel</span>
        </button>
        <button class="custom-action-item" data-action="tache">
            <i data-lucide="calendar-clock"></i>
            <span>Programmer un email</span>
        </button>
        <button class="custom-action-item" data-action="autre">
            <i data-lucide="video"></i>
            <span>Envoyer l'invitation Teams</span>
        </button>
    </div>

    <!-- Custom Confirm Modal -->
    <div id="customConfirmModal" class="modal-overlay">
        <div class="modal-content modal-content-small">
            <div class="modal-header">
                <h3 class="modal-title" id="customConfirmTitle">Confirmation</h3>
                <button class="modal-close" id="closeCustomConfirm">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <p id="customConfirmMessage"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="customConfirmCancel">Annuler</button>
                <button class="btn btn-primary" id="customConfirmOk">Confirmer</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Confirmer la suppression</h3>
                <button class="modal-close" id="closeModal">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage">Êtes-vous sûr de vouloir supprimer ce prospect ?</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelDelete">Annuler</button>
                <button class="btn btn-danger" id="confirmDelete">Supprimer</button>
            </div>
        </div>
    </div>

    <!-- Invite Modal -->
    <div id="inviteModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Envoyer un message</h3>
                <button class="modal-close" id="closeInviteModal">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="inviteForm">
                    <div class="form-group">
                        <label class="form-label">Type d'envoi</label>
                        <div class="invite-type-options">
                            <label class="invite-type-option">
                                <input type="radio" name="inviteType" value="presentation">
                                <span class="invite-type-label">
                                    <i data-lucide="presentation"></i>
                                    Envoyer la présentation
                                </span>
                            </label>
                            <label class="invite-type-option">
                                <input type="radio" name="inviteType" value="teams" checked>
                                <span class="invite-type-label">
                                    <i data-lucide="video"></i>
                                    Envoyer l'invitation Teams
                                </span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="inviteSubject" class="form-label">Sujet</label>
                        <input type="text" id="inviteSubject" class="form-input" value="Appel de découverte" required>
                    </div>
                    <div class="form-group" id="inviteDateGroup">
                        <label class="form-label">Date d'envoi programmé</label>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <div style="position: relative; flex: 1;">
                                <input type="date" id="inviteSendDate" class="form-input" required style="padding-right: 2.2rem;">
                                <i data-lucide="calendar" style="position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); pointer-events: none; color: #64748b;"></i>
                            </div>
                            <div style="position: relative; width: 120px;">
                                <input type="time" id="inviteSendTime" class="form-input" required style="padding-right: 2.2rem;">
                                <i data-lucide="clock" style="position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); pointer-events: none; color: #64748b;"></i>
                            </div>
                        </div>
                    </div>
                    <div class="form-group" id="inviteDurationGroup">
                        <label for="inviteDuration" class="form-label">Durée (minutes)</label>
                        <input type="number" id="inviteDuration" class="form-input" value="30" min="15" step="15" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelInvite">Annuler</button>
                <button class="btn btn-primary" id="confirmInvite">Envoyer</button>
            </div>
        </div>
    </div>

    <!-- Depot Modal -->
    <div id="depotModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Dépôt</h3>
                <button class="modal-close" id="closeDepotModal">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="depot-layout">
                    <div class="depot-options-column">
                        <label class="depot-option" data-value="not_recorded">
                            <div class="depot-option-header">
                                <input type="radio" name="depotStatus" value="not_recorded">
                                <span class="depot-option-label">Je n'ai pas pu enregistrer</span>
                            </div>
                            <div class="depot-details-container" id="depotNotRecordedDetails" style="display: none;">
                                <div class="depot-instructions-warning">
                                    <i data-lucide="alert-circle"></i>
                                    <div>
                                        <strong>Soyez précis et exhaustif :</strong>
                                        <ul>
                                            <li>Décrivez tous les points abordés pendant l'appel</li>
                                            <li>Mentionnez toutes les échéances évoquées</li>
                                            <li>Si un RDV Visio est prévu, indiquez la date et l'heure exactes</li>
                                            <li>Notez le niveau d'intérêt du prospect et les prochaines étapes</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="form-group" style="margin-top: 1rem;">
                                    <label class="form-label">Détails complets de l'appel <span style="color: #ef4444;">*</span></label>
                                    <textarea id="notRecordedDetails" class="form-input" rows="6" placeholder="Ex: Appel avec M. Dupont, très intéressé par notre solution d'automatisation. Évoque un projet de refonte de leur processus de facturation prévu pour février 2025. RDV Visio fixé le 15/11/2025 à 14h30 pour présentation détaillée. Demande un devis d'ici fin novembre. Budget estimé 15-20K€. Contact décisionnaire, prochaine étape : envoyer présentation par email." required></textarea>
                                </div>
                            </div>
                        </label>
                        <label class="depot-option" data-value="no_contact">
                            <input type="radio" name="depotStatus" value="no_contact">
                            <span class="depot-option-label">N'a pas décroché</span>
                        </label>
                        <label class="depot-option" data-value="booked">
                            <input type="radio" name="depotStatus" value="booked">
                            <span class="depot-option-label">RDV réservé</span>
                        </label>
                        <label class="depot-option" data-value="in_app_recording" id="inAppRecordingOption" style="display: none;">
                            <div class="depot-option-header">
                                <input type="radio" name="depotStatus" value="in_app_recording">
                                <span class="depot-option-label">
                                    <i data-lucide="mic" style="width: 18px; height: 18px; margin-right: 0.5rem; color: var(--danger-color); vertical-align: middle;"></i>
                                    Envoyer l'enregistrement in app
                                </span>
                            </div>
                            <div class="depot-recording-info" id="depotRecordingInfo" style="display: none; margin-top: 0.75rem; padding: 0.75rem; background: #f8fafc; border-radius: 8px; font-size: 0.875rem; color: #64748b;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <i data-lucide="clock" style="width: 16px; height: 16px;"></i>
                                    <span id="depotRecordingDuration">Durée: --:--</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;">
                                    <i data-lucide="calendar" style="width: 16px; height: 16px;"></i>
                                    <span id="depotRecordingTime">Heure: --:--:--</span>
                                </div>
                            </div>
                        </label>
                        <label class="depot-option" data-value="recorded">
                            <div class="depot-option-header">
                                <input type="radio" name="depotStatus" value="recorded">
                                <span class="depot-option-label">J'ai l'enregistrement</span>
                            </div>
                            <div class="depot-upload-container" id="depotUploadContainer">
                                <div class="depot-upload-zone">
                                    <input type="file" id="depotFileInput" accept=".wav,.mp3,.aiff,.aac,.ogg,.flac,.m4a,audio/wav,audio/mpeg,audio/mp3,audio/x-aiff,audio/aac,audio/ogg,audio/flac,audio/mp4,audio/x-m4a" style="display: none;">
                                    <div class="depot-upload-content">
                                        <i data-lucide="upload" class="depot-upload-icon"></i>
                                        <p class="depot-upload-text">Cliquez pour téléverser ou glissez-déposez le fichier</p>
                                        <p class="depot-upload-hint">Formats acceptés : WAV, MP3, M4A</p>
                                    </div>
                                </div>
                            </div>
                        </label>
                    </div>
                    <div class="depot-fields-column">
                        <div class="depot-datetime">
                            <label for="depotDateTime" class="depot-datetime-label">Date et heure de l'évènement</label>
                            <input type="datetime-local" id="depotDateTime" class="depot-datetime-input">
                        </div>
                        <div class="depot-note">
                            <label for="depotNote" class="depot-note-label">Ajouter une note</label>
                            <textarea id="depotNote" class="depot-note-input" placeholder="Saisissez votre note ici..." rows="4"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelDepot">Annuler</button>
                <button class="btn btn-primary" id="confirmDepot">Valider</button>
            </div>
        </div>
    </div>

    <!-- Add Prospect Modal -->
    <div id="addProspectModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Ajouter un prospect</h3>
                <button class="modal-close" id="closeAddProspectModal">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="addProspectForm">
                    <div class="form-group">
                        <label for="prospectFirstName" class="form-label">Prénom</label>
                        <input type="text" id="prospectFirstName" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label for="prospectLastName" class="form-label">Nom</label>
                        <input type="text" id="prospectLastName" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label for="prospectEmail" class="form-label">Email</label>
                        <input type="email" id="prospectEmail" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="prospectPhone" class="form-label">Téléphone</label>
                        <input type="tel" id="prospectPhone" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="prospectFirm" class="form-label">Entreprise</label>
                        <div class="firm-input-container">
                            <input type="text" id="prospectFirm" class="form-input" placeholder="Saisir le nom de l'entreprise..." autocomplete="off" required>
                            <div class="firm-autocomplete-dropdown" id="firmAutocompleteDropdown" style="display: none;"></div>
                            <div class="firm-status" id="firmStatus" style="display: none;"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="prospectRole" class="form-label">Rôle</label>
                        <input type="text" id="prospectRole" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="prospectLinkedin" class="form-label">LinkedIn</label>
                        <input type="url" id="prospectLinkedin" class="form-input" placeholder="https://linkedin.com/in/...">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelAddProspect">Annuler</button>
                <button class="btn btn-primary" id="submitAddProspect">Ajouter</button>
            </div>
        </div>
    </div>

    <!-- Record Modal -->
    <div id="recordModal" class="record-modal-overlay">
        <div class="record-modal-content">
            <div class="record-prospect-name" id="recordProspectName"></div>
            
            <div class="record-source-dropdown">
                <button class="record-source-btn" id="recordSourceBtn">
                    <span id="recordSourceText">Source</span>
                    <i data-lucide="chevron-down"></i>
                </button>
                <div class="record-source-menu" id="recordSourceMenu" style="display: none;">
                    <label class="record-source-menu-item">
                        <input type="radio" name="recordSource" value="microphone" checked>
                        <i data-lucide="mic"></i>
                        <span>Microphone</span>
                    </label>
                    <label class="record-source-menu-item">
                        <input type="radio" name="recordSource" value="system">
                        <i data-lucide="speaker"></i>
                        <span>Sortie audio</span>
                    </label>
                </div>
            </div>
            
            <div class="record-waveform-container">
                <div class="record-waveform" id="recordWaveform">
                    <!-- Waveform bars will be generated dynamically -->
                </div>
            </div>
            
            <div class="record-timer" id="recordTimer">00:00</div>
            
            <div class="record-buttons-group">
                <button class="record-btn-start" id="startRecordBtn" title="Démarrer l'enregistrement" style="display: flex;">
                    <i data-lucide="circle"></i>
                    <span style="margin-left: 0.5rem;">Démarrer l'enregistrement</span>
                </button>
                <button class="record-btn-stop" id="stopRecordBtn" title="Fin enregistrement" style="display: none;">
                    <i data-lucide="square"></i>
                    <span style="margin-left: 0.5rem;">Fin enregistrement</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Prospect Details Modal -->
    <div id="prospectDetailsModal" class="modal-overlay">
        <div class="modal-content modal-content-large">
            <div class="modal-header">
                <h3 class="modal-title" id="prospectDetailsTitle">Détails du prospect</h3>
                <div class="modal-header-actions" id="prospectDetailsHeaderActions">
                    <!-- Buttons will be added dynamically -->
                </div>
                <button class="modal-close" id="closeProspectDetailsModal">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <!-- Infos du tableau -->
                <div class="prospect-details-section">
                    <h4 class="prospect-section-title">Informations</h4>
                    <div class="prospect-info-grid" id="prospectInfoGrid">
                        <!-- Rempli dynamiquement -->
                    </div>
                </div>

                <!-- Note personnelle -->
                <div class="prospect-details-section">
                    <h4 class="prospect-section-title">Note personnelle</h4>
                    <div class="prospect-note" id="prospectNote">
                        <p class="prospect-note-placeholder">Aucune note personnelle pour le moment.</p>
                    </div>
                </div>

                <!-- Résumé de la personne -->
                <div class="prospect-details-section">
                    <h4 class="prospect-section-title">Résumé de la personne</h4>
                    <div class="prospect-summary" id="prospectSummary">
                        <p class="prospect-summary-placeholder">Aucun résumé disponible pour le moment.</p>
                    </div>
                </div>

                <!-- Activités de l'entreprise -->
                <div class="prospect-details-section">
                    <h4 class="prospect-section-title">Activités de l'entreprise</h4>
                    <div class="prospect-activities" id="prospectActivities">
                        <p class="prospect-activities-placeholder">Aucune activité renseignée pour le moment.</p>
                    </div>
                </div>

                <!-- Timeline des appels -->
                <div class="prospect-details-section">
                    <h4 class="prospect-section-title">Appels</h4>
                    <div class="prospect-timeline" id="prospectTimeline">
                        <!-- Timeline items -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="closeProspectDetails">Fermer</button>
            </div>
        </div>
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://umyfwukmztoheladdskl.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVteWZ3dWttenRvaGVsYWRkc2tsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5NTk0NjgsImV4cCI6MjA3NDUzNTQ2OH0.VfPX_hF79hinKyDc4qTJ6IHZMiY82BUoBtsJg9uGpzc';
        
        window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const supabase = window.supabaseClient;

        // Check authentication and redirect if not logged in
        async function checkAuth() {
            const { data: { session }, error } = await supabase.auth.getSession();
            
            if (error || !session) {
                // No session, redirect to login
                window.location.href = 'login.html';
                return;
            }
            
            // User is authenticated, load user info
            loadUserInfo(session.user);
        }

        // Load user information from users table
        async function loadUserInfo(authUser) {
            try {
                // Get user data from users table using UUID
                const { data: userData, error } = await supabase
                    .from('users')
                    .select('id, first_name, last_name, email, avatar_url, role, mission')
                    .eq('uuid', authUser.id)
                    .single();

                if (error) {
                    console.error('Error fetching user data:', error);
                    // Fallback to auth user email
                    updateUserDisplay(authUser.email, null, null);
                    return;
                }

                if (userData) {
                    // Store user ID globally for use in prospects
                    window.currentUserId = userData.id;
                    
                    // Store user name globally for transfers
                    window.currentUserFirstName = userData.first_name || '';
                    window.currentUserLastName = userData.last_name || '';
                    window.currentUserEmail = userData.email || authUser.email || '';
                    window.currentUserFullName = (userData.first_name && userData.last_name) 
                        ? `${userData.first_name} ${userData.last_name}`
                        : userData.first_name || userData.last_name || authUser.email?.split('@')[0] || 'Utilisateur';
                    
                    // Update user display with data from users table
                    const firstName = userData.first_name || '';
                    const lastName = userData.last_name || '';
                    const fullName = firstName && lastName 
                        ? `${firstName} ${lastName}`
                        : firstName || lastName || authUser.email?.split('@')[0] || 'Utilisateur';
                    
                    updateUserDisplay(fullName, userData.avatar_url, userData.email);
                    
                    // Update script commercial with user name if needed
                    updateScriptName(userData.first_name, userData.last_name);
                    
                    // Display mission if available
                    displayMission(userData.mission, userData.first_name);
                    
                    // Show analytics tab if user is admin
                    if (userData.role === 'admin') {
                        const analyticsNavItem = document.getElementById('analyticsNavItem');
                        if (analyticsNavItem) {
                            analyticsNavItem.style.display = 'block';
                        }
                    }
                } else {
                    // No user data found, use auth email
                    updateUserDisplay(authUser.email?.split('@')[0] || 'Utilisateur', null, authUser.email);
                }
            } catch (error) {
                console.error('Error loading user info:', error);
                // Fallback to auth user email
                updateUserDisplay(authUser.email?.split('@')[0] || 'Utilisateur', null, authUser.email);
            }
        }

        // Display mission reminder on dashboard
        function displayMission(mission, firstName) {
            const missionReminder = document.getElementById('missionReminder');
            const missionText = document.getElementById('missionText');
            const missionGreeting = document.getElementById('missionGreeting');
            
            if (!missionReminder || !missionText || !missionGreeting) return;
            
            if (mission && mission.trim() !== '') {
                // Display greeting with first name
                if (firstName && firstName.trim() !== '') {
                    missionGreeting.textContent = `Bonjour ${firstName} !`;
                } else {
                    missionGreeting.textContent = 'Bonjour !';
                }
                
                missionText.textContent = mission;
                missionReminder.style.display = 'flex';
                
                // Reinitialize icons
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            } else {
                missionReminder.style.display = 'none';
            }
        }

        // Update user display in sidebar
        function updateUserDisplay(name, avatarUrl, email) {
            const userFirstNameEl = document.querySelector('.user-first-name');
            const userLastNameEl = document.querySelector('.user-last-name');
            const userAvatarEl = document.querySelector('.user-avatar');
            
            // Split name into first and last name
            const nameParts = name ? name.split(' ') : [];
            const firstName = nameParts[0] || '';
            const lastName = nameParts.slice(1).join(' ') || '';
            
            if (userFirstNameEl) {
                userFirstNameEl.textContent = firstName;
            }
            
            if (userLastNameEl) {
                userLastNameEl.textContent = lastName;
            }
            
            if (userAvatarEl) {
                userAvatarEl.src = avatarUrl || 'assets/default.webp';
                userAvatarEl.alt = name;
            }
        }

        // Update script commercial with user name
        function updateScriptName(firstName, lastName) {
            if (firstName && lastName) {
                const scriptNameEl = document.querySelector('.script-name');
                if (scriptNameEl) {
                    scriptNameEl.textContent = `${firstName} ${lastName}`;
                }
            }
        }

        // Initialize auth check
        checkAuth();
        // Force agent section initialization after auth (affiche suggestions même si sidebar non ouverte)
        document.addEventListener('DOMContentLoaded', () => {
            // Attendre que l'utilisateur soit chargé (window.currentUserId)
            const waitUser = setInterval(() => {
                if (window.supabaseClient && window.currentUserId) {
                    clearInterval(waitUser);
                    if (typeof initAgentSection === 'function') {
                        initAgentSection();
                    }
                }
            }, 100);
            // Timeout après 5s
            setTimeout(() => clearInterval(waitUser), 5000);
        });
    </script>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Support Modal -->
    <div class="modal-overlay" id="supportModal">
        <div class="modal-content modal-content-small">
            <div class="modal-header">
                <h3 class="modal-title" style="font-size:1.1rem; display:flex; align-items:center; gap:0.5rem;">
                    <i data-lucide="alert-circle" style="width:20px; height:20px; color:#006EFF;"></i>
                    Signaler un problème
                </h3>
                <button class="btn-icon modal-close" id="closeSupportModal">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <p style="font-size:0.85rem; color:#4b5b70; margin-bottom:1rem;">Décrivez le problème rencontré. Notre équipe analysera votre message. Ajoutez autant de détails que possible.</p>
                <textarea id="supportMessage" placeholder="Ex: Impossible de charger les prospects, erreur 500..." style="width:100%; min-height:140px; resize:vertical; padding:0.75rem; font-family:Sora; font-size:0.9rem; border:1px solid #d6dde7; border-radius:8px;"></textarea>
                <div id="supportError" style="display:none; color:#d51f1f; font-size:0.75rem; margin-top:0.4rem;">Le message est vide.</div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelSupportBtn" type="button">Annuler</button>
                <button class="btn btn-primary" id="sendSupportBtn" type="button">Envoyer</button>
            </div>
        </div>
    </div>
    
    <script src="script.js?v=20251116-18"></script>
N'a pas décroché
    <script src="analytics.js?v=20251116-15"></script>
    <script>
        // Initialize Lucide icons
        lucide.createIcons();
    </script>
</body>
</html>

